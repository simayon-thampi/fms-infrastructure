# Production-ready Docker Compose file for FMS Deployment

services:
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "443:443"
      - "80:80"
      - "8443:443"
    volumes:
      - ./nginx_conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx_conf/00-log-format.conf:/etc/nginx/conf.d/00-log-format.conf:ro
      - ./nginx_conf/snippets:/etc/nginx/snippets:ro
      - ./certs/nginx:/etc/nginx/certs:ro
      - ./certs/internal/ca.crt:/etc/nginx/ca/ca.crt:ro
      - nginx_logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx
      # SSL certs from Certbot
      #- /etc/letsencrypt/live/fms.conque.trizlabz.com:/etc/nginx/certs:ro
      #- ./nginx_conf:/etc/nginx/conf.d:ro
      #- ./snippets:/etc/nginx/snippets:ro
      #- /etc/letsencrypt:/etc/letsencrypt:ro
      # - fms_logos:/app/static/logos:ro # Mount the shared logos volume
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - application-service
      - user-service
      - device-core
      - mission-service
      - deployment-service
      - dashboard-service
      - traffic-management-service
      - alert-service
      - analytics-service
      - fmscore-frontend
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    networks:
      - fmsnet

  application-service:
    image: fms-application-service:stable
    container_name: application-service
    volumes:
      - ./certs/internal/application-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/application-service.key:/etc/service-certs/cert.key:ro
      - ${FMS_STORAGE_BASE}/app-icons:/app/uploads/app-icons
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${APPLICATION_SERVICE_PORT}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/applications
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=applications
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - MQTT_BROKER_HOST=${MQTT_BROKER_HOST}
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT}
      - API_STR=/api
      - BACKEND_CORS_ORIGINS=https://localhost:8443
      - UPLOAD_DIRECTORY=/app/uploads/app-icons
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  user-service:
    image: fms-user-service:stable # <-- Added image name
    container_name: user-service
    # network_mode: "host"
    volumes:
      - ./certs/internal/user-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/user-service.key:/etc/service-certs/cert.key:ro
      - /home/ubuntu/Temporary-Folder:/app/shared
      - ${FMS_STORAGE_BASE}/logos:/app/uploads
      - ${LICENSE_PATH}:/app/license
      - /sys:/sys:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - MONGODB_URL=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@${MONGODB_HOST}:${MONGODB_PORT}/admin
      - MONGODB_DATABASE=iotcore_usermanagement
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=5
      - CORS_ORIGINS=${CORS_ORIGINS}
      - LICENSE_FILE_PATH=/app/license/license.lic
    command: [ "npm", "start" ]
    restart: unless-stopped
    networks:
      - fmsnet

  device-core:
    image: fms-device-core:stable
    container_name: device-core
    volumes:
      - ./certs/internal/device-core.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/device-core.key:/etc/service-certs/cert.key:ro
      - /home/ubuntu/FMS-localstorage/license:/app/license:ro
      - /sys:/sys:ro
      # Mount MQTT certs from a standardized location
      - ./certs/mqtt/ca.crt:/etc/mqtt-certs/ca.crt:ro
      - ./certs/mqtt/client.crt:/etc/mqtt-certs/client.crt:ro
      - ./certs/mqtt/client.key:/etc/mqtt-certs/client.key:ro
    environment:
      - PORT=8004
      - HOST=0.0.0.0
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/devices
      - DB_SYNCHRONIZE=false
      - INFLUX_URL=http://host.docker.internal:8086
      - INFLUX_TOKEN=Alpty_r2NC6MOASy5f1lXs0reAFvZ832kUqHzIBCQWm1naoBbbG3tiB9lFunsR2ASBEgsURODDHiAXGOaRiriw==
      - INFLUX_ORG=trizlabz
      - INFLUX_BUCKET=device_core
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_BROKERS_JSON=["host.docker.internal:9092"]
      - KAFKA_CLIENT_ID=device-telemetry-service
      - KAFKA_GROUP_ID=device-telemetry-group
      - KAFKAJS_NO_PARTITIONER_WARNING=1
      - TYPEORM_ENTITIES=dist/models/**/*.js
      - TYPEORM_MIGRATIONS=dist/migrations/**/*.js
      - LICENSE_PATH=/app/license/license.lic
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - MQTT_BROKER_HOST=13.204.138.62
      - MQTT_CA_CERT_PATH=/etc/mqtt-certs/ca.crt
      - MQTT_CLIENT_CERT_PATH=/etc/mqtt-certs/client.crt
      - MQTT_CLIENT_KEY_PATH=/etc/mqtt-certs/client.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: [ "node", "dist/server.js" ]
    restart: unless-stopped
    networks:
      - fmsnet

  mission-service:
    image: fms-mission-service:stable
    container_name: mission-service
    command: [ "node", "dist/index.js" ]
    ports:
      - "8005:8005"
    volumes:
      - ./certs/internal/mission-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/mission-service.key:/etc/service-certs/cert.key:ro
    environment:
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/missions
      - CORS_ORIGIN=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - PORT=8005
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - SHADOW_DATABASE_URL=postgres://admin:password@host.docker.internal:5432/missions
      - HISTORY_API=http://log-service:8011/api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  deployment-service:
    image: fms-deployment-service:stable
    container_name: deployment-service
    user: root
    volumes:
      - ./certs/internal/deployment-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/deployment-service.key:/etc/service-certs/cert.key:ro
      - $HOME/FMS-localstorage/zone_map:/app/uploads/maps
      - $HOME/FMS-localstorage/plant_image:/app/uploads/plant-image
      - $HOME/FMS-localstorage/zone_image:/app/uploads/zone-image
      - $HOME/FMS-localstorage/map_yaml:/app/uploads/configs
      - $HOME/FMS-localstorage/zones:/app/uploads/zones
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PORT=8006
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/deployment
      - ZONE_STORAGE_PATH=/app/uploads/zones
      - MAP_STORAGE_PATH=/app/uploads/maps
      - CONFIG_STORAGE_PATH=/app/uploads/configs
      - PLANT_IMAGE_STORAGE_PATH=/app/uploads/plant-image
      - ZONE_IMAGE_STORAGE_PATH=/app/uploads/zone-image
      - DB_SYNCHRONIZE=false
      - NODE_ENV=development
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    restart: unless-stopped
    networks:
      - fmsnet

  dashboard-service:
    image: fms-dashboard-service:stable
    container_name: dashboard-service
    ports:
      - "8007:8007"
    user: root
    volumes:
      - ./certs/internal/dashboard-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/dashboard-service.key:/etc/service-certs/cert.key:ro
    environment:
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/dashboard
      - PORT=8007
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  alert-service:
    image: fms-alert-service:stable
    container_name: alert-service
    ports:
      - "8008:8008"
    volumes:
      - ./certs/internal/alert-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/alert-service.key:/etc/service-certs/cert.key:ro
    environment:
      - NODE_ENV=production
      - PORT=8008
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USERNAME=admin
      - DB_PASSWORD=password
      - DB_NAME=alerts_db
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_DEVICE_METRICS_TOPIC=device-telemetry
      - KAFKA_TOPIC_ALERTS=device-telemetry
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=false
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  traffic-management-service:
    image: fms-traffic-management-service:stable
    container_name: traffic-management-service
    ports:
      - "8009:8009"
    volumes:
      - ./certs/internal/traffic-management-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/traffic-management-service.key:/etc/service-certs/cert.key:ro
      - /home/ubuntu/FMS-localstorage/license:/app/license:ro
      - /sys:/sys:ro
    environment:
      - NODE_ENV=production
      - PORT=8009
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/traffic_management
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_CLIENT_ID=traffic-management-service
      - KAFKA_GROUP_ID=traffic-management-group
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      - FMS_MISSION_SERVICE_URL=https://mission-service:8005
      - FMS_DEVICE_CORE_URL=https://device-core:8004
      - DEPLOYMENT_SERVICE_URL=https://deployment-service:8006/api
      - PG_HOST=host.docker.internal
      - PG_PORT=5432
      - PG_USER=admin
      - PG_PASSWORD=password
      - PG_DATABASE=traffic_management
      - ENABLE_PATH_RESERVATION=false
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - LICENSE_PATH=/app/license/license.lic
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  analytics-service:
    image: fms-analytics-service:stable
    container_name: analytics-service
    ports:
      - "8010:8010"
    volumes:
      - ./certs/internal/analytics-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/analytics-service.key:/etc/service-certs/cert.key:ro
    environment:
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/traffic_management?schema=public
      - CORS_ORIGIN=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - DEBUG=prisma:*
      - PRISMA_LOG_LEVEL=info
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  log-service:
    image: fms-log-service:stable
    container_name: log-service
    ports:
      - "8011:8011"
    volumes:
      - ./certs/internal/log-service.crt:/etc/service-certs/cert.crt:ro
      - ./certs/internal/log-service.key:/etc/service-certs/cert.key:ro
    environment:
      - NODE_ENV=production
      - PORT=8011
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USERNAME=admin
      - DB_PASSWORD=password
      - DB_DATABASE=fms_history_db
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443", "https://neev3.trizlabz.com:8443","https://192.168.147.208:8443"]
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  fmscore-frontend:
    image: fms-fmscore-frontend:stable
    container_name: fmscore-frontend
    environment:
      - NEXT_PUBLIC_API_BASE_URL=https://neev3.trizlabz.com:8443
      - NEXT_PUBLIC_BASE_URL=https://neev3.trizlabz.com:8443
      - NEXT_PUBLIC_WS_URL=https://neev3.trizlabz.com:8443
      - SERVER_IP=neev3.trizlabz.com
      - NEXT_PUBLIC_MAP_VIEW_API=https://asaichi.dnha.ap.fiot.globaldenso.com/api/widgets/getKPIValuesByLines
      - NEXT_PUBLIC_MAP_VIEW_API_TOKEN=3082010A0282010100E1C31BB7EE4280D5AC0CB69ABE4593615B28165D074E8EED2AF5AA7EC1CB7F10D09AB6D8319E5A9DAD87D6CC484719AC72BB8FB19770FA37FE054F3D25A4FF9AB665BFC3B3884B766FDC758BFF47F5F0BB6D6075871273B4181E11AB07FAF82F984EBD9DD5C0B7FD3C91B0F0F7CB7509F252191678567FF5B7312DBE3AB6EB5A96A75FC52F6E938C0B1790C8AA2366B8CDEC7AEFAB5DCEE0BEEBC0ADC3281694B4922FBE43AB2A9AE30AE430491ABFEA6FFC28FFB2EBD713F95460BEDE5C62D27E426A98439C997CAA09362A4E65196E8E1732019937C3769BD4786B89E7AAC2542843659D9ADA7B7E962A427141FA71BA4F2F851541A353B2F449FE98C79ACD0203010001
      # Runtime environment variables for server-side InfluxDB access
      # Use host.docker.internal to reach host machine from container
      - INFLUX_URL=http://neev3.trizlabz.com:8086
      - INFLUX_TOKEN=Alpty_r2NC6MOASy5f1lXs0reAFvZ832kUqHzIBCQWm1naoBbbG3tiB9lFunsR2ASBEgsURODDHiAXGOaRiriw==
      - INFLUX_ORG=trizlabz
    restart: unless-stopped
    networks:
      - fmsnet

volumes:
  nginx_cache:
  nginx_logs:


networks:
  fmsnet:
    driver: bridge
