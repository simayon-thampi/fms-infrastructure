# ---- Nginx Configuration ----

resolver 127.0.0.11 ipv6=off valid=30s;
resolver_timeout 5s;


# ---- Dynamic upstream targets via variables ----
map "" $usersvc     { default "user-service:8002"; }
map "" $devicesvc   { default "device-core:8004"; }
map "" $appsvc      { default "application-service:8003"; }
map "" $missionsvc  { default "mission-service:8005"; }
map "" $deploysvc   { default "deployment-service:8006"; }
map "" $dashboardsvc { default "dashboard-service:8007"; }
map "" $alertsvc    { default "alert-service:8008"; }
map "" $trafficsvc  { default "traffic-management-service:8009"; } 
map "" $analyticssvc { default "analytics-service:8010"; } 


# ---- Build Authorization header from jwt cookie (HTTP context) ----
map $http_cookie $jwt_token {
  default "";
  "~*jwt=([^;]+)" $1;
}
map $jwt_token $auth_bearer {
  default "";
  "~.+" "Bearer $jwt_token";
}

# ---- Cache (HTTP context) ----
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=apicache:100m max_size=500m inactive=10m use_temp_path=off;

# ---- WebSocket upgrade helper ----
map $http_upgrade $connection_upgrade { default upgrade; "" close; }

# ---------------- HTTP -> HTTPS redirect ----------------
server {
  listen 80;
  return 301 https://$host:8443$request_uri;   # host port for 443 is 8443 in compose
}

# ---------------- HTTPS gateway ----------------
server {
  listen 443 ssl;
  http2 on;
  server_name localhost 127.0.0.1;

  # ---- TLS certs (mounted at /etc/nginx/certs) ----
  ssl_certificate     /etc/nginx/certs/localhost.crt;
  ssl_certificate_key /etc/nginx/certs/localhost.key;

  # ---- Static files (logos) ----
  location /static/logos/ {
    alias /app/static/logos/;
    expires 30d;
    add_header Cache-Control "public, no-transform";
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    try_files $uri =404;
  }

  # ---- Frontend (Next.js) - Proxy to dev server ----
  location / {
    # Proxy to Next.js dev/build server running on host
    # Port 3000 for Next.js dev/build, 5173 for Vite

# TODO: Change this to 3000 when Next.js is ready
    # proxy_pass http://fmscore-frontend:3000;
    proxy_pass http://host.docker.internal:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # WebSocket support for HMR (Hot Module Replacement)
    proxy_read_timeout 86400;
  }

  # ---- Verify upstream services over HTTPS using internal CA (only for TLS backends) ----
  proxy_ssl_server_name on;
  proxy_ssl_protocols TLSv1.2 TLSv1.3;
  proxy_ssl_verify on;
  proxy_ssl_verify_depth 2;
  proxy_ssl_trusted_certificate /etc/nginx/ca/ca.crt;

  # ---- Harden BOTH auth cookies at the edge ----
  proxy_cookie_flags jwt            secure httponly samesite=Lax;
  proxy_cookie_flags refresh_token  secure httponly samesite=Lax;

  # ---- Logging ----
  access_log /var/log/nginx/access.json json;
  error_log  /var/log/nginx/error.log warn;

  # ---- General proxy settings ----
  client_max_body_size 10m;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Request-Id $request_id;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host  $host;

  # ---- CORS (gateway is the single source of truth) ----
  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;
  proxy_hide_header Access-Control-Allow-Headers;
  proxy_hide_header Access-Control-Allow-Methods;
  proxy_hide_header Access-Control-Expose-Headers;
  proxy_hide_header Vary;

  # allow only your dev frontends; edit ports if needed
  set $cors_origin "";
  if ($http_origin ~* ^https?://localhost:(5173|3000|8443)$) { set $cors_origin $http_origin; }

  # --- exact: login (avoids upstream 307 redirects) ---
  # ---- OPTIONAL ALIAS: expose auth under /api/users/auth/* too ----
  location = /api/users/auth/login {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/auth/login;
  }

  location = /api/users/auth/refresh {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "POST, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;

    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != POST)   { return 405; }   # enforce POST

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/auth/refresh;
  }

  location = /api/users/auth/logout {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/auth/logout;
  }

  location = /api/users/auth/register {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/;
  }

  location = /api/users/auth/validate-session {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/auth/validate-session;
  }


  # -------------- Public auth catch-all (other /api/auth/*) --------------
  location /api/auth/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_set_header Cookie $http_cookie;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/auth/;
  }

  # ---------- Internal auth check (cookie only; used by auth_request) ----------
  location = /auth {
    internal;
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/validate;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Original-URI $request_uri;
  }

  # Consistent 401 JSON when /auth rejects
  error_page 401 = @error401;
  location @error401 {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;

    default_type application/json;
    return 401 '{"error":"unauthorized","message":"Missing or invalid token"}';
  }

  # quick probe
  location = /whoami {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/validate;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Cookie $http_cookie;
  }

  # --- exact: customers list/create ---
  # === Customers (protected) — clean public path: /api/customers ===

  # exact: list/create -> backend /customers
  location = /api/customers {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;

    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/customers;
    proxy_redirect https://user-service:3002/ https://$host:8443/;
  }

  # prefix: /api/customers/* -> backend /customers/*
  location ^~ /api/customers/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;

    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/customers/(.*)$ /customers/$1 break;

    proxy_ssl_name user-service;
    proxy_pass https://$usersvc;
    proxy_redirect https://user-service:3002/ https://$host:8443/;
  }

  # ---------- Users (protected) EXACT: list/create ----------
  location = /api/users {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    add_header X-Gateway-Users "exact" always;
    if ($request_method = OPTIONS) { return 204; }
  
    # Authenticate the request
    auth_request /auth;
    auth_request_set $user_id $sent_http_x_user_id;
    auth_request_set $user_email $sent_http_x_user_email;
    auth_request_set $user_roles $sent_http_x_roles;
    
    # Forward to user service with query parameters
    proxy_set_header X-User-Id $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles $user_roles;
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header Authorization $auth_bearer;
    
    # Preserve query parameters
    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/users/$is_args$args;
    proxy_redirect https://user-service:3002/ https://$host:8443/;
  }

  # ---------- Users (protected) PREFIX: /api/users/* ----------
  location ^~ /api/users/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    add_header X-Gateway-Users "prefix" always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/users/(.*)$ /users/$1 break;

    proxy_ssl_name user-service;
    proxy_pass https://$usersvc;
    proxy_redirect https://user-service:3002/ https://$host:8443/;
  }

  location = /api/graphql {
    # This location proxies to Next.js API route on port 3000
    # OPTIONS requests are handled by Next.js route handler
    
    # Proxy configuration
    proxy_pass http://host.docker.internal:3000/api/graphql;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Cookie $http_cookie;
    
    # Timeouts
    proxy_read_timeout 300;
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
  }

  # --- Service account token (public) ---
  location = /api/service-accounts/token {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "POST, OPTIONS" always;
    add_header Vary Origin always;

    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != POST)   { return 405; }  # enforce POST

    proxy_ssl_name user-service;
    proxy_pass https://$usersvc/service-accounts/token;
  }

  # ---------- Alert Service WebSocket (protected) ----------
  location /socket.io/ {
    # WebSocket upgrade
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Authentication
    auth_request /auth; # Use the standard HTTPS auth check
    auth_request_set $auth_status $upstream_status;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_roles  $upstream_http_x_roles;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Roles $user_roles;

    # CORS headers
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Roles" always;
    add_header Vary Origin always;

    # Handle preflight
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Methods     "GET, POST, OPTIONS" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }

    # WebSocket timeouts
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_connect_timeout 60s;

    # Proxy to the alert service
    proxy_pass http://$alertsvc/socket.io/$is_args$args;
 }

  # default.conf

# ---------- Device Service WebSocket (protected) ----------
  location = /api/v1/ws {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    auth_request /auth;
    # auth_request_set $user_id $upstream_http_x_user_id;
    # proxy_set_header X-User-Id $user_id;
    proxy_ssl_verify off;
    proxy_ssl_name device-service;
    proxy_pass https://$devicesvc/api/v1/ws;
}




  # ---------- Dashboards (protected) ----------
  location ~ ^/api/(custom-)?dashboards {
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin      $cors_origin always;
      add_header Access-Control-Allow-Credentials 'true' always;
      add_header Access-Control-Allow-Headers     'Content-Type, Authorization, X-Requested-With, X-Customer-Id' always;
      add_header Access-Control-Allow-Methods     'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
      return 204;
    }

    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials 'true' always;
    add_header Access-Control-Allow-Headers     'Content-Type, Authorization, X-Requested-With, X-Customer-Id' always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;

    auth_request /auth;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name dashboard-service;
    proxy_pass https://$dashboardsvc$request_uri;
    proxy_redirect https://dashboard-service:8007/ https://$host:8443/;
  }


  # ---------- Devices (protected) EXACT: list ----------
  location = /api/devices {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Cache-Control, Pragma, Expires" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;

    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name device-core;
    proxy_pass https://$devicesvc/api/v1/devices/;
    proxy_redirect /api/v1/ /api/devices/;
  }

  # FE:  /api/devices/telemetry/recent/<id>?limit=5
  location ^~ /api/devices/telemetry/recent/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Cache-Control, Pragma, Expires" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/devices/telemetry/recent/([0-9a-fA-F-]+)$ /api/v1/telemetry/recent/$1 break;
    proxy_intercept_errors on;
    error_page 404 = @telemetry_recent_alt;

    proxy_ssl_name device-core;
    proxy_pass https://$devicesvc;
    proxy_redirect /api/v1/ /api/devices/;
  }

  # Fallback: /api/v1/devices/<id>/telemetry/recent
  location @telemetry_recent_alt {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Cache-Control, Pragma, Expires" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/devices/telemetry/recent/([0-9a-fA-F-]+)$ /api/v1/devices/$1/telemetry/recent break;
    proxy_ssl_name device-core;
    proxy_pass https://$devicesvc;
    proxy_redirect /api/v1/ /api/devices/;
  }

  # ---------- Devices (protected) PREFIX ----------
  location ^~ /api/devices/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Cache-Control, Pragma, Expires" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/devices/(.*)$ /api/v1/devices/$1 break;
    proxy_ssl_name device-core;
    proxy_pass https://$devicesvc;
    proxy_redirect /api/v1/ /api/devices/;
  }

    # ---------- License (protected) ----------
  location ^~ /api/license/ {
    access_log /var/log/nginx/license-access.log json;
    error_log /var/log/nginx/license-error.log debug;
    
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Cache-Control, Pragma, Expires" always;
    add_header Access-Control-Allow-Methods     "GET, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/license/(.*)$ /api/v1/license/$1 break;
    proxy_ssl_name device-core;
    proxy_pass https://$devicesvc;
    proxy_redirect https://$devicesvc/api/v1/license/ https://$host:8443/api/license/;
  }

  # ---- Applications (protected) —  ----
  location = /api/applications {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, OPTIONS" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name application-service;
    proxy_pass https://$appsvc/api/v1/applications/$is_args$args;
    proxy_redirect https://application-service:3003/api/v1/applications/ https://$host:8443/api/applications;
  }

  location ^~ /api/applications/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/applications/?$    /api/v1/applications/ break;
    rewrite ^/api/applications/(.*)$ /api/v1/applications/$1 break;

    proxy_ssl_name application-service;
    proxy_pass https://$appsvc;
    proxy_redirect https://application-service:3003/api/v1/applications/ https://$host:8443/api/applications/;
  }

  # ---------------- Versions (protected) ----------------
  location ~ ^/api/versions(?<rest>/.*)?$ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    if ($rest = "") { rewrite ^ /api/v1/versions/ break; }
    rewrite ^ /api/v1/versions$rest break;

    proxy_redirect https://application-service:3003/ https://$host:8443/;
    proxy_ssl_name application-service;
    proxy_pass https://$appsvc;
  }

  location ^~ /mission {
    add_header X-Gateway-Compat "mission-legacy" always;
    rewrite ^/mission(/.*)?$ /api/mission$1 last;
  }

  # ---------- Missions (protected)  list/create ----------
  location = /api/mission {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id     $user_id;
    proxy_set_header X-User-Email  $user_email;
    proxy_set_header X-Roles       $user_roles;
    proxy_set_header X-Scopes      $user_scopes;
    proxy_set_header X-Customer-Id $http_x_customer_id;

    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name mission-service;
    proxy_pass https://$missionsvc/api/mission$is_args$args;
  }

  location ^~ /api/mission/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id     $user_id;
    proxy_set_header X-User-Email  $user_email;
    proxy_set_header X-Roles       $user_roles;
    proxy_set_header X-Scopes      $user_scopes;
    proxy_set_header X-Customer-Id $http_x_customer_id;

    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name mission-service;
    proxy_pass https://$missionsvc;
  }

  # ---------- Deployment Service (protected) ----------
  location = /api/deployments {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc/api/deployments;
  }

  location ^~ /api/deployments/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc;
  }

  location = /api/zones {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc/api/zones;
  }

  location ^~ /api/zones/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc;
  }

  location = /api/plants {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc/api/plants;
  }

  location ^~ /api/plants/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc;
  }

  location ~ ^/api/path-layers/zone/([0-9a-fA-F-]+)$ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    rewrite ^/api/path-layers/zone/([0-9a-fA-F-]+)$ /api/zones/$1/path-layers break;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc;
  }

  location = /api/path-layers {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc/api/path-layers;
  }

  location ^~ /api/path-layers/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-JWT-Exp" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id    $user_id;
    proxy_set_header X-User-Email $user_email;
    proxy_set_header X-Roles      $user_roles;
    proxy_set_header X-Scopes     $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name deployment-service;
    proxy_pass https://$deploysvc;
  }

  location = /api/scheduler {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id     $user_id;
    proxy_set_header X-User-Email  $user_email;
    proxy_set_header X-Roles       $user_roles;
    proxy_set_header X-Scopes      $user_scopes;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;
    proxy_set_header X-Customer-Id $http_x_customer_id;

    proxy_ssl_name mission-service;
    proxy_pass https://$missionsvc/api/scheduler$is_args$args;
  }

  # --- Alerts Service (protected) ---
# This single block handles all /api/alerts/* and /api/alert-triggers/* routes
location ~ ^/api/(alerts|alert-triggers) {
    # CORS headers for browser access
    add_header 'Access-Control-Allow-Origin'      $cors_origin always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods'     'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'     'Content-Type, Authorization, X-Requested-With, cache-control' always;
    add_header 'Access-Control-Expose-Headers'    'X-User-Id, X-User-Email, X-Roles, X-Scopes' always;
    add_header 'Vary' 'Origin' always;

    # Handle preflight OPTIONS requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # Authenticate the request before proxying
    auth_request /auth;

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    # CORRECTED: Proxy to the HTTP backend
    proxy_pass http://$alertsvc$request_uri;
}


  location ^~ /api/scheduler/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id     $user_id;
    proxy_set_header X-User-Email  $user_email;
    proxy_set_header X-Roles       $user_roles;
    proxy_set_header X-Scopes      $user_scopes;
    proxy_set_header X-Customer-Id $http_x_customer_id;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name mission-service;
    proxy_pass https://$missionsvc;
  }

  # ---------- Traffic Management Service (protected) ----------
  # Handles scheduler executions, mission executions, and waypoint executions
  location ~ ^/api/(scheduler-executions|mission-executions|waypoint-executions) {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    auth_request_set $user_id     $upstream_http_x_user_id;
    auth_request_set $user_email  $upstream_http_x_user_email;
    auth_request_set $user_roles  $upstream_http_x_roles;
    auth_request_set $user_scopes $upstream_http_x_scopes;

    proxy_set_header X-User-Id     $user_id;
    proxy_set_header X-User-Email  $user_email;
    proxy_set_header X-Roles       $user_roles;
    proxy_set_header X-Scopes      $user_scopes;
    proxy_set_header X-Customer-Id $http_x_customer_id;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;

    proxy_ssl_name traffic-management-service;
    proxy_pass https://$trafficsvc;
  }

  # ---------- Analytics Service (protected) ----------
  location ^~ /api/analytics/ {
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Requested-With, X-Customer-Id" always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Expose-Headers    "X-User-Id, X-User-Email, X-Roles, X-Scopes, X-Customer-Id" always;
    add_header Vary Origin always;
    if ($request_method = OPTIONS) { return 204; }

    auth_request /auth;
    proxy_set_header Cookie        $http_cookie;
    proxy_set_header Authorization $auth_bearer;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Proxy full URI to analytics service (service expects /api/analytics prefix)
    proxy_pass http://$analyticssvc;
  }
}