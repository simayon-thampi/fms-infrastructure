services:
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "8443:443"
    volumes:
      - ./default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./00-log-format.conf:/etc/nginx/conf.d/00-log-format.conf:ro
      - ../certs/nginx:/etc/nginx/certs:ro
      - ../certs/internal/ca.crt:/etc/nginx/ca/ca.crt:ro
      - ../logs/nginx:/var/log/nginx
      - nginx_cache:/var/cache/nginx
      - $HOME/FMS-usermanagement/static/logos:/app/static/logos
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      application-service:
        condition: service_started
      user-service:
        condition: service_started
      device-core:
        condition: service_started
      mission-service:
        condition: service_started
      deployment-service:
        condition: service_started
      dashboard-service:
        condition: service_started
      traffic-management-service:
        condition: service_started
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    networks:
      - fmsnet

  application-service:
    build: ../FMS-application-service
    image: fms-application-service:latest # <-- Added image name
    container_name: application-service
    volumes:
      - ../certs/internal/application-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/application-service.key:/etc/service-certs/cert.key:ro
      - $HOME/FMS-localstorage/app-icons:/app/uploads/app-icons
    command:
      - uvicorn
      - app.main:app
      - --host
      - 0.0.0.0
      - --port
      - "8003"
      - --ssl-certfile
      - /etc/service-certs/cert.crt
      - --ssl-keyfile
      - /etc/service-certs/cert.key
    environment:
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/applications
      - SQLALCHEMY_DATABASE_URI=postgresql://admin:password@host.docker.internal:5432/applications
      - SECRET_KEY=supersecretkey
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - MQTT_BROKER_HOST=host.docker.internal
      - MQTT_BROKER_PORT=1883
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", 'python -c "import sys; sys.exit(0)"']
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - fmsnet

  user-service:
    build: ../FMS-usermanagement
    image: fms-user-service:latest # <-- Added image name
    container_name: user-service
    # network_mode: "host"
    volumes:
      - ../certs/internal/user-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/user-service.key:/etc/service-certs/cert.key:ro
      - $HOME/Temporary-Folder:/app/shared
      - $HOME/FMS-localstorage/logos:/app/uploads
      - $HOME/FMS-localstorage/license:/app/license
      - /sys:/sys:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - MONGODB_URL=mongodb://host.docker.internal:27017/iotcore_usermanagement
      - SECRET_KEY=${SECRET_KEY:-supersecretkey}
      - ACCESS_TOKEN_EXPIRE_MINUTES=5
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      - LICENSE_FILE_PATH=/app/license/license.lic
    command:
      [
        "uvicorn",
        "app.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8002",
        "--ssl-certfile",
        "/etc/service-certs/cert.crt",
        "--ssl-keyfile",
        "/etc/service-certs/cert.key",
      ]
    restart: unless-stopped
    networks:
      - fmsnet

  device-core:
    build: ../FMS-device-core
    image: fms-device-core:latest # <-- Added image name
    container_name: device-core
    ports:
      - "8004:8004"
    env_file:
      - ../FMS-device-core/.env
    volumes:
      - ../certs/internal/device-core.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/device-core.key:/etc/service-certs/cert.key:ro
      - $HOME/FMS-localstorage/license:/app/license:ro
      - /sys:/sys:ro
      # Mount MQTT certs
      - /home/govindtriz22/machine_mqtt_certs/ca.crt:/etc/mqtt-certs/ca.crt:ro
      - /home/govindtriz22/machine_mqtt_certs/client.crt:/etc/mqtt-certs/client.crt:ro
      - /home/govindtriz22/machine_mqtt_certs/client.key:/etc/mqtt-certs/client.key:ro
    environment:
      - HOST=0.0.0.0
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/devices
      - DB_SYNCHRONIZE=false
      - INFLUX_URL=http://host.docker.internal:8086
      - INFLUX_TOKEN=tovrpN8MZ2RbzDDViK5WEGS77u7VqtAQvVEuEQ8RxHig8q373j3sPXkLOqfmRgrrpwWj-V8Uaj60qzlPAvaSFA==
      - INFLUX_ORG=trizlabz
      - INFLUX_BUCKET=device_core
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_BROKERS_JSON=["host.docker.internal:9092"]
      - KAFKA_CLIENT_ID=device-telemetry-service
      - KAFKA_GROUP_ID=device-telemetry-group
      - KAFKAJS_NO_PARTITIONER_WARNING=1
      - TYPEORM_ENTITIES=dist/models/**/*.js
      - TYPEORM_MIGRATIONS=dist/migrations/**/*.js
      - LICENSE_PATH=/app/license/license.lic
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - MQTT_BROKER_HOST=192.168.0.139
      - MQTT_CA_CERT_PATH=/etc/mqtt-certs/ca.crt
      - MQTT_CLIENT_CERT_PATH=/etc/mqtt-certs/client.crt
      - MQTT_CLIENT_KEY_PATH=/etc/mqtt-certs/client.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["node", "dist/server.js", "--port", "8004"]
    restart: unless-stopped
    networks:
      - fmsnet

  mission-service:
    build:
      context: ../FMS-mission-service
      dockerfile: Dockerfile
    image: fms-mission-service:latest
    container_name: mission-service
    command: ["node", "dist/index.js"]
    ports:
      - "8005:8005"
    # --- ✅ ADDED FOR HTTPS ---
    volumes:
      - ../certs/internal/mission-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/mission-service.key:/etc/service-certs/cert.key:ro
    environment:
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/missions
      - CORS_ORIGIN=["http://localhost:5173","http://localhost:3000","https://localhost:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - PORT=8005
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  deployment-service:
    build: ../FMS-deployment-service
    image: fms-deployment-service:latest # <-- Added image name
    container_name: deployment-service
    env_file:
      - ../FMS-deployment-service/.env
    # --- ✅ ADDED FOR HTTPS ---
    volumes:
      - ../certs/internal/deployment-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/deployment-service.key:/etc/service-certs/cert.key:ro
      - $HOME/FMS-localstorage/zone_map:/app/uploads/maps
      - $HOME/FMS-localstorage/plant_image:/app/uploads/plant-image
      - $HOME/FMS-localstorage/zone_image:/app/uploads/zone-image
      - $HOME/FMS-localstorage/map_yaml:/app/uploads/configs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PORT=8006
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/deployment
      - MAP_STORAGE_PATH=/app/uploads/maps
      - CONFIG_STORAGE_PATH=/app/uploads/configs
      - PLANT_IMAGE_STORAGE_PATH=/app/uploads/plant-image
      - ZONE_IMAGE_STORAGE_PATH=/app/uploads/zone-image
      - DB_SYNCHRONIZE=false
      - NODE_ENV=development
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    restart: unless-stopped
    networks:
      - fmsnet

  dashboard-service:
    build: ../FMS-dashboard-services
    image: fms-dashboard-service:latest # <-- Added image name
    container_name: dashboard-service
    ports:
      - "8007:8007"
    # --- ✅ ADDED FOR HTTPS ---
    user: root
    volumes:
      - ../certs/internal/dashboard-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/dashboard-service.key:/etc/service-certs/cert.key:ro
    environment:
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/dashboard
      - PORT=8007
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  alert-service:
    build: ../FMS-alert-service
    image: fms-alert-service:latest # <-- Added image name
    container_name: alert-service
    ports:
      - "8008:8008"
    # --- ✅ ADDED FOR HTTPS ---
    volumes:
      - ../certs/internal/alert-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/alert-service.key:/etc/service-certs/cert.key:ro
    environment:
      - NODE_ENV=production
      - PORT=8008
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USERNAME=admin
      - DB_PASSWORD=password
      - DB_NAME=alerts_db
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_DEVICE_METRICS_TOPIC=device-telemetry
      - KAFKA_TOPIC_ALERTS=device-telemetry
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=false
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  analytics-service:
    build: ../FMS-analytics-services
    image: fms-analytics-service:latest
    container_name: analytics-service
    ports:
      - "8010:8010"
    volumes:
      - ../certs/internal/analytics-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/analytics-service.key:/etc/service-certs/cert.key:ro
    env_file:
      - ../FMS-analytics-services/.env
    environment:
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/traffic_management?schema=public
      - CORS_ORIGIN=["http://localhost:5173","http://localhost:3000","https://localhost:8443"]
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - DEBUG=prisma:*
      - PRISMA_LOG_LEVEL=info
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

  traffic-management-service:
    build: ../traffic-management-service
    image: fms-traffic-management-service:latest # <-- Added image name
    container_name: traffic-management-service
    ports:
      - "8009:8009"
    # --- ✅ ADDED FOR HTTPS ---
    volumes:
      - ../certs/internal/traffic-management-service.crt:/etc/service-certs/cert.crt:ro
      - ../certs/internal/traffic-management-service.key:/etc/service-certs/cert.key:ro
      - $HOME/FMS-localstorage/license:/app/license:ro
      - /sys:/sys:ro
    environment:
      - NODE_ENV=production
      - PORT=8009
      - DATABASE_URL=postgresql://admin:password@host.docker.internal:5432/traffic_management
      - KAFKA_BROKERS=host.docker.internal:9092
      - KAFKA_CLIENT_ID=traffic-management-service
      - KAFKA_GROUP_ID=traffic-management-group
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000","https://localhost:8443","https://192.168.147.208:8443"]
      - FMS_MISSION_SERVICE_URL=https://mission-service:8005
      - FMS_DEVICE_CORE_URL=https://device-core:8004
      - DEPLOYMENT_SERVICE_URL=https://deployment-service:8006/api
      - PG_HOST=host.docker.internal
      - PG_PORT=5432
      - PG_USER=admin
      - PG_PASSWORD=password
      - PG_DATABASE=traffic_management
      # --- ✅ ADDED FOR HTTPS ---
      - ENABLE_HTTPS=true
      - SSL_CERT_PATH=/etc/service-certs/cert.crt
      - SSL_KEY_PATH=/etc/service-certs/cert.key
      - LICENSE_PATH=/app/license/license.lic
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - fmsnet

volumes:
  nginx_cache:

networks:
  fmsnet:
    driver: bridge

